<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="cokr.xit.adds.biz.nims.dao.BizNimsMapper">

    <!-- **************************************************************************** -->
    <!-- NIMS API start -->
    <!-- **************************************************************************** -->
    <insert id="mergeBsshInfoSt" parameterType="cokr.xit.adds.inf.nims.model.NimsApiDto$BsshInfoSt">
        /** nims-mysql-mapper|mergeBsshInfoSt-마약류취급자정보 생성/변경|julim  */
        INSERT INTO tb_bssh_info(
            bssh_cd,        /* 마약류취급자식별번호 */
            bssh_nm,        /* 마약류취급자명 */
            induty_nm,      /* 업종명 */
            hdnt_cd,        /* 의료업자구분 */
            hdnt_nm,        /* 의료업자구분명 */
            bizrno,         /* 사업자등록번호 */
            rprsntv_nm,     /* 대표자명 */
            chrg_nm,        /* 담당자명 */
            hptl_no,        /* 요양기관번호 */
            join_yn,        /* 회원가입여부 */
            bssh_stts_nm,   /* 마약류취급자상태명 */
            prmisn_no,      /* 허가번호 */
            use_yn,
            reg_dt,
            rgtr
        ) VALUES (
            #{bsshCd},
            #{bsshNm},
            #{indutyNm},
            #{hdntCd},
            #{hdntNm},
            #{bizrno},
            #{rprsntvNm},
            #{chrgNm},
            #{hptlNo},
            #{joinYn},
            #{bsshSttusNm},
            #{prmisnNo},
            'Y',
            DATE_FORMAT(now(), '%Y%m%d%H%i%s'),
            #{rgtr}
        )
        ON DUPLICATE KEY UPDATE
            bssh_nm = #{bsshNm},            /* 마약류취급자명 */
            induty_nm = #{indutyNm},        /* 업종명 */
            hdnt_cd = #{hdntCd},            /* 의료업자구분 */
            hdnt_nm = #{hdntNm},            /* 의료업자구분명 */
            bizrno = #{bizrno},             /* 사업자등록번호 */
            rprsntv_nm = #{rprsntvNm},      /* 대표자명 */
            chrg_nm = #{chrgNm},            /* 담당자명 */
            hptl_no = #{hptlNo},            /* 요약기관번호 */
            join_yn = #{joinYn},            /* 가입여부 */
            bssh_stts_nm = #{bsshSttusNm},  /* 마약류취급자상태명 */
            prmisn_no = #{prmisnNo},        /* 허가번호 */
            mdfcn_dt = DATE_FORMAT(now(), '%Y%m%d%H%i%s'),
            mdfr = #{rgtr}
    </insert>

    <insert id="mergeProductInfoKd" parameterType="cokr.xit.adds.inf.nims.model.NimsApiDto$ProductInfoKd">
        /** nims-mysql-mapper|mergeProductInfoKd-상품정보 생성|julim  */
        INSERT INTO tb_prduct_info(
            prduct_cd,              /* 제품코드 */
            prdlst_mst_cd,          /* 제품대표코드 */
            prduct_nm,              /* 제품명 */
            nrcd_se_nm,             /* 마약항정구분 */
            prtm_se_nm,             /* 중점일반구분 */
            prd_min_distb_qy,       /* 최소유통단위수량 - 제품규격정보(고정값=1) */
            std_packng_stle_nm,     /* 제품최소유통단위 */
            prd_tot_pce_qy,         /* 제품총낱개단위수량 */
            pce_co_unit_nm,         /* 제품낱개단위 */
            bssh_cd,                /* 마약류취급자식별번호 */
            rgs_dt,                 /* 등록일 */
            upd_dt,                 /* 변경일 */
            use_yn,
            reg_dt,
            rgtr
        ) VALUES (
            #{prductCd},
            #{prdlstMstCd},
            #{prductNm},
            #{nrcdSeNm},
            #{prtmSeNm},
            #{prdMinDistbQy},
            #{stdPackngStleNm},
            #{prdTotPceQy},
            #{pceCoUnitNm},
            #{bsshCd},
            #{rgsDt},
            #{updDt},
            'Y',
            DATE_FORMAT(now(), '%Y%m%d%H%i%s'),
            #{rgtr}
        )
        ON DUPLICATE KEY UPDATE
            prdlst_mst_cd = #{prdlstMstCd},             /* 제품대표코드 */
            prduct_nm = #{prductNm},                    /* 제품명 */
            nrcd_se_nm = #{nrcdSeNm},                   /* 마약항정구분 */
            prtm_se_nm = #{prtmSeNm},                   /* 중점일반구분 */
            prd_min_distb_qy = #{prdMinDistbQy},        /* 최소유통단위수량 - 제품규격정보(고정값=1) */
            std_packng_stle_nm = #{stdPackngStleNm},    /* 제품최소유통단위 */
            prd_tot_pce_qy = #{prdTotPceQy},            /* 제품총낱개단위수량 */
            pce_co_unit_nm = #{pceCoUnitNm},            /* 제품낱개단위 */
            bssh_cd = #{bsshCd},                        /* 마약류취급자식별번호 */
            rgs_dt = #{rgsDt},                          /* 등록일 */
            upd_dt = #{updDt},                          /* 변경일 */
            mdfcn_dt = DATE_FORMAT(now(), '%Y%m%d%H%i%s'),
            mdfr = #{rgtr}
    </insert>

    <!-- **************************************************************************** -->
    <!-- NIMS API end -->
    <!-- **************************************************************************** -->


    <!-- **************************************************************************** -->
    <!-- ADDS BIZ start -->
    <!-- **************************************************************************** -->
    <select id="selectDsuseRptInfoByUsrRptIdNo" parameterType="map" resultType="cokr.xit.adds.inf.nims.model.NimsApiDto$DsuseRptInfo">
        /** nims-mysql-mapper|selectDsuseRptInfoByUsrRptIdNo-폐기보고정보 데이타 조회|julim  */
        SELECT usr_rpt_id_no,       /* 사용자보고식별번호 */
               ref_usr_rpt_id_no,   /* 참조사용자식별번호 */
               bssh_cd,             /* 마약류취급자식별번호 */
               bssh_nm,             /* 마약류취급자명 */
               induty_nm,           /* 업종명 */
               rpt_ty_cd,           /* 보고유형코드 */
               rnd_dtl_rpt_cnt,     /* 수불상세보고수 */
               hdr_de,              /* 취급일자 */
               rpt_de,              /* 보고일자 */
               dsuse_se_cd,         /* 폐기구분코드 */
               dsuse_prv_cd,        /* 폐기사유코드 */
               dsuse_mth_cd,        /* 폐기방법코드 */
               dsuse_loc,           /* 폐기장소 */
               dsuse_de,            /* 폐기일자 */
               status,              /* 상태 */
               rpt_prg_stts_cd,     /* 보고진행상태코드 */
               org_usr_rpt_id_no,   /* 원본사용자보고식별번호 */
               use_yn,
               reg_dt,
               rgtr
          FROM tb_dsuse_rpt_info
         WHERE usr_rpt_id_no = #{usrRptIdNo}
           <if test="useYn != null">
           AND use_yn = #{useYn}
           </if>
           <if test="userId != null">
           AND userId = #{userId}
           </if>
    </select>

    <select id="selectDsuseRptInfoDtls" parameterType="map" resultType="cokr.xit.adds.inf.nims.model.NimsApiDto$DsuseRptInfoDtl">
        /** nims-mysql-mapper|selectDsuseRptInfoDtls-폐기보고정보 상세 조회|julim  */
        SELECT tdrid.usr_rpt_id_no,      /* 사용자보고식별번호 */
               tdrid.usr_rpt_ln_id_no,   /* 사용자보고라인식별번호 */
               tdrid.prduct_cd,          /* 제품코드 */
               tdrid.prduct_nm,          /* 제품명 */
               tdrid.min_distb_qy,       /* 최소유통단위수량 */
               tdrid.pce_qy,             /* 낱개단위수량 */
               tdrid.mnf_no,             /* 제조번호 */
               tdrid.prd_valid_de,       /* 제품유효기한일자 */
               tdrid.mnf_seq,            /* 제품일련번호 */
               tdrid.mvmn_ty_cd,         /* 이동유형코드 */
               tdrid.dsuse_qy,           /* 폐기수량 */
               tdrid.use_yn,
               tdrid.reg_dt,
               tdrid.rgtr,
               tpi.nrcd_se_nm,           /* 마약항정구분 */
               tpi.prtm_se_nm            /* 중점일반구분 */
          FROM tb_dsuse_rpt_info_dtl tdrid
          LEFT JOIN tb_prduct_info tpi
            ON (tdrid.prduct_cd = tpi.prduct_cd)
            --    AND tdrid.use_yn = 'Y')
         WHERE tdrid.usr_rpt_id_no = #{usrRptIdNo}
           <if test="usrRptLnIdNo != null">
           AND tdrid.usr_rpt_ln_id_no = #{usrRptLnIdNo}
           </if>
           <if test="useYn != null">
           AND tdrid.use_yn = #{useYn}
           </if>
           <if test="userId != null">
           AND tdrid.userId = #{userId}
           </if>
    </select>

    <insert id="insertDsuseRptInfo" parameterType="cokr.xit.adds.inf.nims.model.NimsApiDto$DsuseRptInfo">
        /** nims-mysql-mapper|insertDsuseRptInfo-폐기보고정보 생성|julim  */
        INSERT INTO tb_dsuse_rpt_info (
            usr_rpt_id_no,          /* 사용자보고식별번호 */
            ref_usr_rpt_id_no,      /* 참조사용자식별번호 */
            bssh_cd,                /* 마약류취급자식별번호 */
            bssh_nm,                /* 마약류취급자명 */
            induty_nm,              /* 업종명 */
            rpt_ty_cd,              /* 보고유형코드 : AAR - 폐기보고 */
            rnd_dtl_rpt_cnt,        /* 수불상세보고수 */
            hdr_de,                 /* 취급일자 */
            rpt_de,                 /* 보고일자 */
            dsuse_se_cd,            /* 폐기구분코드 */
            dsuse_prv_cd,           /* 폐기사유코드 */
            dsuse_mth_cd,           /* 폐기방법코드 */
            dsuse_loc,              /* 폐기장소 */
            dsuse_de,               /* 폐기일자 */
            status,                 /* 상태 */
            rpt_prg_stts_cd,        /* 보고진행상태코드 */
            org_usr_rpt_id_no,      /* 원본사용자보고식별번호 */
            use_yn,
            reg_dt,
            rgtr
        ) VALUES (
            #{usrRptIdNo},
            #{refUsrRptIdNo},
            #{bsshCd},
            #{bsshNm},
            #{indutyNm},
            #{rptTyCd},
            #{rndDtlRptCnt},
            #{hdrDe},
            #{rptDe},
            #{dsuseSeCd},
            #{dsusePrvCd},
            #{dsuseMthCd},
            #{dsuseLoc},
            #{dsuseDe},
            #{status},
            #{rptPrgSttsCd},
            #{orgUsrRptIdNo},
            IF(#{rptTyCd} = '1', 'N', 'Y'),
            DATE_FORMAT(now(), '%Y%m%d%H%i%s'),
            #{rgtr}
        )
    </insert>

    <insert id="insertDsuseRptInfoDtl" parameterType="cokr.xit.adds.inf.nims.model.NimsApiDto$DsuseRptInfoDtl">
        /** nims-mysql-mapper|insertDsuseRptInfoDtl-폐기보고정보 상세 생성|julim  */
        INSERT INTO tb_dsuse_rpt_info_dtl (
            usr_rpt_id_no,      /* 사용자보고식별번호 */
            usr_rpt_ln_id_no,   /* 사용자보고라인식별번호 */
            prduct_cd,          /* 제품코드 */
            prduct_nm,          /* 제품명 */
            min_distb_qy,       /* 최소유통단위수량 */
            pce_qy,             /* 낱개단위수량 */
            mnf_no,             /* 제조번호 */
            prd_valid_de,       /* 제품유효기한일자 */
            mnf_seq,            /* 제품일련번호 */
            mvmn_ty_cd,         /* 이동유형코드 */
            dsuse_qy,           /* 폐기수량 */
            use_yn,
            reg_dt,
            rgtr
        ) VALUES (
            #{usrRptIdNo},
            #{usrRptLnIdNo},
            #{prductCd},
            #{prductNm},
            #{minDistbQy},
            #{pceQy},
            #{mnfNo},
            #{prdValidDe},
            #{mnfSeq},
            #{mvmnTyCd},
            #{dsuseQy},
            'Y',
            DATE_FORMAT(now(), '%Y%m%d%H%i%s'),
            #{rgtr}
         )
    </insert>

    <update id="updateCancelDsuseRptInfo" parameterType="cokr.xit.adds.inf.nims.model.NimsApiDto$DsuseRptInfo">
        /** nims-mysql-mapper|updateCancelDsuseRptInfo-폐기보고정보 취소|julim  */
        UPDATE tb_dsuse_rpt_info
           SET use_yn = 'N'
             , mdfcn_dt = DATE_FORMAT(now(), '%Y%m%d%H%i%s')
             , mdfr = #{rgtr}
         WHERE usr_rpt_id_no = #{refUsrRptIdNo}
           AND use_yn = 'Y'
    </update>

    <update id="updateCancelDsuseMgt" parameterType="cokr.xit.adds.inf.nims.model.NimsApiDto$DsuseRptInfo">
        /** nims-mysql-mapper|updateCancelDsuseMgt-폐기관리 취소(참조사용자식별번호로)|julim  */
        UPDATE tb_dsuse_mgt
           SET usr_rpt_id_no = #{usrRptIdNo}
             , use_yn = IF(#{rptTyCd} = '1', 'N', use_yn)
             , mdfcn_dt = DATE_FORMAT(now(), '%Y%m%d%H%i%s')
             , mdfr = #{rgtr}
         WHERE usr_rpt_id_no = #{refUsrRptIdNo}
           AND use_yn = 'Y'
    </update>

    <update id="updateCancelDsuseRptInfoDtl" parameterType="cokr.xit.adds.inf.nims.model.NimsApiDto$DsuseRptInfo">
        /** nims-mysql-mapper|updateCancelDsuseRptInfoDtl-폐기보고정보 상세 취소|julim  */
        UPDATE tb_dsuse_rpt_info_dtl
           SET use_yn = 'N'
             , mdfcn_dt = DATE_FORMAT(now(), '%Y%m%d%H%i%s')
             , mdfr = #{rgtr}
         WHERE usr_rpt_id_no = #{refUsrRptIdNo}
           AND use_yn = 'Y'
    </update>

    <select id="recusiveRefUsrRptIdNo" parameterType="string" resultType="map">
        /** nims-mysql-mapper|recusiveRefUsrRptIdNo-참조번호 recurive 조회|julim  */
        SELECT usr_rpt_id_no as usrRptIdNo
             , ref_usr_rpt_id_no as refUsrRptIdNo
             , rpt_ty_cd as rptTyCd
          FROM tb_dsuse_rpt_info
         WHERE usr_rpt_id_no = #{refUsrRptIdNo}
    </select>


    <insert id="insertDsuseMgt" parameterType="cokr.xit.adds.biz.nims.model.BizNimsRequest$DsuseMgt">
        /** nims-mysql-mapper|insertDsuseMgt-폐기관리 생성|julim  */
        <selectKey keyProperty="dscdmngId" resultType="string" order="BEFORE">
            SELECT NVL(MAX(dscdmng_id), CONCAT(DATE_FORMAT(now(), '%Y%m'),'0000')) + 1
              FROM tb_dsuse_mgt
             WHERE dscdmng_id LIKE CONCAT(DATE_FORMAT(now(), '%Y%m'), '%');
        </selectKey>
        INSERT INTO tb_dsuse_mgt (
            dscdmng_id,             /* 폐기관리ID */
            user_id,                /* 사용자ID */
            usr_rpt_id_no,          /* 사용자보고식별번호 */
            org_usr_rpt_id_no,      /* 원사용자보고식별번호 */
            prgrs_stts_cd,          /* 폐기관리진행상태코드 */
            use_yn,
            reg_dt,
            rgtr
        ) VALUES (
            #{dscdmngId},
            #{userId},
            #{usrRptIdNo},
            #{orgUsrRptIdNo},
            #{prgrsSttsCd},
            'Y',
            DATE_FORMAT(now(), '%Y%m%d%H%i%s'),
            #{rgtr}
        )
    </insert>

    <select id="selectSavedDsuseMgts" parameterType="java.util.List" resultType="cokr.xit.adds.biz.nims.model.BizNimsResponse$DsuseMgtResponse">
        /** nims-mysql-mapper|selectSavedDsuseMgts-저장 폐기관리목록 조회|julim  */
        <include refid="sqlDsuseMgt"/>
         WHERE tdm.dscdmng_id IN
             <foreach collection="list" item="item" separator="," open="(" close=")">
               #{item}
             </foreach>
    </select>

    <select id="selectDsuseMgts" parameterType="cokr.xit.adds.biz.nims.model.BizNimsRequest$DsuseMgtInq" resultType="cokr.xit.adds.biz.nims.model.BizNimsResponse$DsuseMgtResponse">
        /** nims-mysql-mapper|selectDsuseMgts-폐기관리목록 조회|julim  */
        <include refid="sqlDsuseMgt"/>
        WHERE tdm.dscdmng_id IN
        <foreach collection="dscdmngIds" item="item" separator="," open="(" close=")">
            #{item}
        </foreach>
    </select>

    <sql id="sqlDsuseMgt">
        SELECT tdm.dscdmng_id           /** 폐기관리ID */
             , tdm.user_id              /** 사용자ID */
             , tdm.usr_rpt_id_no        /** 사용자보고식별번호 */
             , tdm.org_usr_rpt_id_no    /** 원사용자보고식별번호 */
             , tdri.bssh_cd             /** 마약류취급자식별번호 */
             , tdri.bssh_nm             /** 마약류취급자명 */
             , tdri.induty_nm           /** 업종명 */
             , tdri.rpt_ty_cd           /** 보고유형코드 */
             , tdri.rnd_dtl_rpt_cnt     /** 수불상세보고수 */
             , tdri.hdr_de              /** 취급일자 */
             , tdri.rpt_de              /** 보고일자 */
             , tdri.dsuse_se_cd         /** 폐기구분코드 */
             , tdri.dsuse_prv_cd        /** 폐기사유코드 */
             , tdri.dsuse_mth_cd        /** 폐기방법코드 */
             , tdri.dsuse_loc           /** 폐기장소 */
             , tdri.dsuse_de            /** 폐기일자 */
             , tdri.status              /** 상태 */
             , tdri.rpt_prg_stts_cd     /** 보고진행상태코드 */
             , tbi.rprsntv_nm           /** 대표자명 */
             , tbi.prmisn_no            /** 허가번호 */
          FROM tb_dsuse_mgt tdm
          JOIN tb_dsuse_rpt_info tdri
            ON (tdm.org_usr_rpt_id_no = tdri.org_usr_rpt_id_no
                AND tdm.usr_rpt_id_no = tdri.usr_rpt_id_no)
          LEFT JOIN tb_bssh_info tbi
            ON tdri.bssh_cd = tbi.bssh_cd
    </sql>

    <!-- **************************************************************************** -->
    <!-- ADDS BIZ end -->
    <!-- **************************************************************************** -->
</mapper>
